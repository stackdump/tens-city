<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <title>Permalink Demo - Before and After Fix</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background: #f5f5f5;
        }
        h1 {
            color: #0366d6;
        }
        .demo-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .before, .after {
            padding: 15px;
            border-radius: 6px;
        }
        .before {
            background: #fff5f5;
            border: 2px solid #e53e3e;
        }
        .after {
            background: #f0fff4;
            border: 2px solid #38a169;
        }
        .before h3 {
            color: #e53e3e;
            margin-top: 0;
        }
        .after h3 {
            color: #38a169;
            margin-top: 0;
        }
        code {
            background: #f6f8fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 13px;
            font-family: monospace;
        }
        pre {
            background: #f6f8fa;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .demo-button {
            padding: 10px 20px;
            font-size: 14px;
            background: #0366d6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        .demo-button:hover {
            background: #0256c7;
        }
        .url-display {
            background: #f6f8fa;
            padding: 10px;
            border-radius: 4px;
            word-break: break-all;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
        }
        .success {
            color: #38a169;
            font-weight: bold;
        }
        .error {
            color: #e53e3e;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üîó Permalink Feature - Before & After Fix Demo</h1>

    <div class="demo-section">
        <h2>The Problem</h2>
        <p>When clicking on the permalink from a page that already has a <code>?data=...</code> parameter in the URL, 
        the permalink would be constructed based on the current URL, which already contains query parameters.</p>
        
        <h3>Scenario:</h3>
        <ol>
            <li>User visits a permalink URL with data in it</li>
            <li>User edits the JSON in the editor</li>
            <li>User clicks the "üîó Permalink" button to share the edited version</li>
            <li><span class="error">BUG:</span> The new permalink is based on the old URL with old parameters</li>
        </ol>
    </div>

    <div class="demo-section">
        <h2>Visual Comparison</h2>
        <div class="comparison">
            <div class="before">
                <h3>‚ùå Before Fix (Buggy)</h3>
                <p>Using: <code>new URL(window.location.href)</code></p>
                <div id="before-demo"></div>
                <button class="demo-button" onclick="runBeforeDemo()">Run Before Demo</button>
            </div>
            <div class="after">
                <h3>‚úÖ After Fix (Correct)</h3>
                <p>Using: <code>new URL(window.location.origin + window.location.pathname)</code></p>
                <div id="after-demo"></div>
                <button class="demo-button" onclick="runAfterDemo()">Run After Demo</button>
            </div>
        </div>
    </div>

    <div class="demo-section">
        <h2>The Fix</h2>
        <p><strong>File:</strong> <code>public/tens-city.js</code></p>
        <p><strong>Method:</strong> <code>_updatePermalinkAnchor()</code></p>
        <p><strong>Line:</strong> 645</p>
        
        <h3>Change:</h3>
        <pre>// BEFORE (buggy):
const url = new URL(window.location.href);

// AFTER (fixed):
const url = new URL(window.location.origin + window.location.pathname);</pre>

        <h3>Why This Works:</h3>
        <ul>
            <li><code>window.location.href</code> includes the full URL with query parameters</li>
            <li><code>window.location.origin + window.location.pathname</code> creates a clean URL without query parameters</li>
            <li>Then we add only the new data parameter to the clean URL</li>
            <li>This ensures each permalink is independent and doesn't carry old parameters</li>
        </ul>
    </div>

    <script>
        function runBeforeDemo() {
            const container = document.getElementById('before-demo');
            container.innerHTML = '<h4>Step-by-step:</h4>';
            
            // Step 1: Start with URL that has old data
            const step1 = document.createElement('p');
            step1.innerHTML = '<strong>1. Current page URL:</strong>';
            container.appendChild(step1);
            
            const url1 = document.createElement('div');
            url1.className = 'url-display';
            const oldUrl = 'http://localhost:8080/index.html?data=%7B%22version%22%3A1%7D';
            url1.textContent = oldUrl;
            container.appendChild(url1);
            
            // Step 2: User edits data
            const step2 = document.createElement('p');
            step2.innerHTML = '<strong>2. User edits JSON to version 2</strong>';
            container.appendChild(step2);
            
            // Step 3: Create permalink using OLD buggy method
            const step3 = document.createElement('p');
            step3.innerHTML = '<strong>3. Create permalink (BUGGY way):</strong>';
            container.appendChild(step3);
            
            const newData = { version: 2, edited: true };
            const buggyUrl = new URL(oldUrl);
            buggyUrl.searchParams.set('data', encodeURIComponent(JSON.stringify(newData)));
            
            const url2 = document.createElement('div');
            url2.className = 'url-display';
            url2.textContent = buggyUrl.toString();
            container.appendChild(url2);
            
            // Result
            const result = document.createElement('p');
            result.className = 'error';
            result.innerHTML = '‚ùå Result: URL still based on old URL structure (might have issues with some edge cases)';
            container.appendChild(result);
        }

        function runAfterDemo() {
            const container = document.getElementById('after-demo');
            container.innerHTML = '<h4>Step-by-step:</h4>';
            
            // Step 1: Start with URL that has old data
            const step1 = document.createElement('p');
            step1.innerHTML = '<strong>1. Current page URL:</strong>';
            container.appendChild(step1);
            
            const url1 = document.createElement('div');
            url1.className = 'url-display';
            const oldUrlString = 'http://localhost:8080/index.html?data=%7B%22version%22%3A1%7D';
            url1.textContent = oldUrlString;
            container.appendChild(url1);
            
            // Step 2: User edits data
            const step2 = document.createElement('p');
            step2.innerHTML = '<strong>2. User edits JSON to version 2</strong>';
            container.appendChild(step2);
            
            // Step 3: Create permalink using NEW fixed method
            const step3 = document.createElement('p');
            step3.innerHTML = '<strong>3. Create permalink (FIXED way):</strong>';
            container.appendChild(step3);
            
            const oldUrl = new URL(oldUrlString);
            const newData = { version: 2, edited: true };
            const fixedUrl = new URL(oldUrl.origin + oldUrl.pathname);
            fixedUrl.searchParams.set('data', encodeURIComponent(JSON.stringify(newData)));
            
            const url2 = document.createElement('div');
            url2.className = 'url-display';
            url2.textContent = fixedUrl.toString();
            container.appendChild(url2);
            
            // Result
            const result = document.createElement('p');
            result.className = 'success';
            result.innerHTML = '‚úÖ Result: Clean URL with only the new data parameter';
            container.appendChild(result);
        }

        // Auto-run demos on load
        window.addEventListener('load', () => {
            runBeforeDemo();
            runAfterDemo();
        });
    </script>
</body>
</html>
