<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Minimal JSON-LD Test</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
        }
        .pass { background: #d4edda; color: #155724; }
        .fail { background: #f8d7da; color: #721c24; }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>JSON-LD Script Tag Feature Test</h1>
    
    <div id="test-container">
        <h2>Test Results</h2>
        <div id="results"></div>
    </div>

    <script type="module">
        const results = document.getElementById('results');
        
        function addResult(name, passed, details) {
            const div = document.createElement('div');
            div.className = 'status ' + (passed ? 'pass' : 'fail');
            div.innerHTML = `<strong>${passed ? '✓' : '✗'} ${name}</strong>`;
            if (details) {
                const pre = document.createElement('pre');
                pre.textContent = details;
                div.appendChild(pre);
            }
            results.appendChild(div);
        }

        // Test 1: URL encoding/decoding
        try {
            const testData = { "@context": "https://pflow.xyz/schema", "@type": "Object" };
            const encoded = encodeURIComponent(JSON.stringify(testData));
            const decoded = JSON.parse(decodeURIComponent(encoded));
            const match = JSON.stringify(testData) === JSON.stringify(decoded);
            addResult('URL Encoding/Decoding', match, 
                `Original: ${JSON.stringify(testData, null, 2)}\nDecoded: ${JSON.stringify(decoded, null, 2)}`);
        } catch (err) {
            addResult('URL Encoding/Decoding', false, err.message);
        }

        // Test 2: URLSearchParams
        try {
            const testUrl = '?data=%7B%22test%22%3A%22value%22%7D';
            const urlParams = new URLSearchParams(testUrl);
            const dataParam = urlParams.get('data');
            const parsed = JSON.parse(decodeURIComponent(dataParam));
            addResult('URLSearchParams', parsed.test === 'value', 
                `Extracted data: ${JSON.stringify(parsed)}`);
        } catch (err) {
            addResult('URLSearchParams', false, err.message);
        }

        // Test 3: Script tag creation
        try {
            const scriptTag = document.createElement('script');
            scriptTag.type = 'application/ld+json';
            const testData = { "@context": "test", "name": "Test" };
            scriptTag.textContent = JSON.stringify(testData, null, 2);
            document.body.appendChild(scriptTag);
            
            // Verify it was added
            const found = document.querySelector('script[type="application/ld+json"]');
            const foundData = JSON.parse(found.textContent);
            
            addResult('Script Tag Creation', foundData.name === 'Test', 
                `Created script tag with:\n${found.textContent}`);
        } catch (err) {
            addResult('Script Tag Creation', false, err.message);
        }

        // Test 4: Script tag reading
        try {
            const scriptTag = document.querySelector('script[type="application/ld+json"]');
            if (scriptTag) {
                const data = JSON.parse(scriptTag.textContent);
                addResult('Script Tag Reading', data !== null, 
                    `Read from script tag:\n${JSON.stringify(data, null, 2)}`);
            } else {
                addResult('Script Tag Reading', false, 'No script tag found');
            }
        } catch (err) {
            addResult('Script Tag Reading', false, err.message);
        }

        // Test 5: Invalid JSON handling
        try {
            JSON.parse('invalid json');
            addResult('Invalid JSON Handling', false, 'Should have thrown an error');
        } catch (err) {
            addResult('Invalid JSON Handling', true, 'Correctly throws error for invalid JSON');
        }

        // Helper function to decode recursively
        function decodeRecursively(encodedData) {
            let decodedData = encodedData;
            
            while (true) {
                try {
                    const nextDecoded = decodeURIComponent(decodedData);
                    if (nextDecoded === decodedData) {
                        break;
                    }
                    decodedData = nextDecoded;
                    
                    try {
                        JSON.parse(decodedData);
                        break;
                    } catch (jsonErr) {
                        // Not valid JSON yet, continue decoding
                    }
                } catch (e) {
                    break;
                }
            }
            
            return decodedData;
        }

        // Test 6: URL creation
        try {
            const testData = { "@context": "https://pflow.xyz/schema", "@type": "Test" };
            const url = new URL(window.location.href);
            url.searchParams.set('data', encodeURIComponent(JSON.stringify(testData)));
            const urlString = url.toString();
            const MAX_URL_DISPLAY_LENGTH = 100;
            const displayUrl = urlString.length > MAX_URL_DISPLAY_LENGTH 
                ? urlString.substring(0, MAX_URL_DISPLAY_LENGTH) + '...' 
                : urlString;
            
            addResult('URL Creation', urlString.includes('?data='), 
                `Generated URL:\n${displayUrl}`);
        } catch (err) {
            addResult('URL Creation', false, err.message);
        }

        // Test 7: Double-encoded URL decoding (issue fix)
        try {
            const testData = { "@context": "https://pflow.xyz/schema", "@type": "Test" };
            const jsonString = JSON.stringify(testData);
            const doubleEncoded = encodeURIComponent(encodeURIComponent(jsonString));
            
            const decodedData = decodeRecursively(doubleEncoded);
            const parsed = JSON.parse(decodedData);
            const match = JSON.stringify(testData) === JSON.stringify(parsed);
            addResult('Double-Encoded URL Decoding', match, 
                `Successfully decoded double-encoded data:\n${JSON.stringify(parsed, null, 2)}`);
        } catch (err) {
            addResult('Double-Encoded URL Decoding', false, err.message);
        }

        // Test 8: Triple-encoded URL decoding (edge case)
        try {
            const testData = { "@context": "https://pflow.xyz/schema", "@type": "EdgeCase" };
            const jsonString = JSON.stringify(testData);
            const tripleEncoded = encodeURIComponent(encodeURIComponent(encodeURIComponent(jsonString)));
            
            const decodedData = decodeRecursively(tripleEncoded);
            const parsed = JSON.parse(decodedData);
            const match = JSON.stringify(testData) === JSON.stringify(parsed);
            addResult('Triple-Encoded URL Decoding', match, 
                `Successfully decoded triple-encoded data:\n${JSON.stringify(parsed, null, 2)}`);
        } catch (err) {
            addResult('Triple-Encoded URL Decoding', false, err.message);
        }

        // Summary
        const passedCount = document.querySelectorAll('.pass').length;
        const totalTests = document.querySelectorAll('.status').length;
        const allPassed = passedCount === totalTests;
        const summary = document.createElement('div');
        summary.className = 'status ' + (allPassed ? 'pass' : 'fail');
        summary.innerHTML = `<strong>Summary: ${passedCount}/${totalTests} tests passed</strong>`;
        results.appendChild(summary);
    </script>
</body>
</html>
