<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Async Initialization Test</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
        }
        .pass { background: #d4edda; color: #155724; }
        .fail { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Async Editor Initialization Test</h1>
    
    <div id="test-container">
        <h2>Test Results</h2>
        <div id="results"></div>
    </div>

    <script type="module">
        const results = document.getElementById('results');
        
        function addResult(name, passed, details) {
            const div = document.createElement('div');
            div.className = 'status ' + (passed ? 'pass' : 'fail');
            div.innerHTML = `<strong>${passed ? '✓' : '✗'} ${name}</strong>`;
            if (details) {
                const pre = document.createElement('pre');
                pre.textContent = details;
                div.appendChild(pre);
            }
            results.appendChild(div);
        }

        function addInfo(message) {
            const div = document.createElement('div');
            div.className = 'status info';
            div.innerHTML = `<strong>ℹ ${message}</strong>`;
            results.appendChild(div);
        }

        // Test 1: Verify async/await syntax for _createEditor
        addInfo('Checking if methods are properly async...');
        
        try {
            const response = await fetch('/tens-city.js');
            const code = await response.text();
            
            // Check if _createEditor is async
            const createEditorAsync = /async\s+_createEditor\s*\(\s*\)/.test(code);
            addResult('_createEditor is async', createEditorAsync, 
                createEditorAsync ? 'Found: async _createEditor()' : 'Not found');
            
            // Check if _showApp is async
            const showAppAsync = /async\s+_showApp\s*\(\s*\)/.test(code);
            addResult('_showApp is async', showAppAsync,
                showAppAsync ? 'Found: async _showApp()' : 'Not found');
            
            // Check if _createEditor awaits _initAceEditor
            const createEditorAwaits = /await\s+this\._initAceEditor\s*\(/.test(code);
            addResult('_createEditor awaits _initAceEditor', createEditorAwaits,
                createEditorAwaits ? 'Found: await this._initAceEditor(' : 'Not found');
            
            // Check if _showApp awaits _createEditor
            const showAppAwaitsCreate = /await\s+this\._createEditor\s*\(/.test(code);
            addResult('_showApp awaits _createEditor', showAppAwaitsCreate,
                showAppAwaitsCreate ? 'Found: await this._createEditor()' : 'Not found');
            
            // Check if _showApp awaits _loadInitialData
            const showAppAwaitsLoad = /await\s+this\._loadInitialData\s*\(/.test(code);
            addResult('_showApp awaits _loadInitialData', showAppAwaitsLoad,
                showAppAwaitsLoad ? 'Found: await this._loadInitialData()' : 'Not found');
            
            // Check if _checkAuth awaits _showApp
            const checkAuthAwaits = /async\s+_checkAuth[\s\S]*?await\s+this\._showApp\s*\(/.test(code);
            addResult('_checkAuth awaits _showApp', checkAuthAwaits,
                checkAuthAwaits ? 'Found: await this._showApp() in _checkAuth' : 'Not found');
            
            // Check if auth state change listener awaits _showApp
            const authStateAwaits = /onAuthStateChange\s*\(\s*async[\s\S]*?await\s+this\._showApp\s*\(/.test(code);
            addResult('Auth state change listener awaits _showApp', authStateAwaits,
                authStateAwaits ? 'Found: await this._showApp() in onAuthStateChange' : 'Not found');
            
        } catch (err) {
            addResult('Code Analysis', false, err.message);
        }

        // Test 2: Verify execution order with mock
        addInfo('Testing execution order with mock...');
        
        try {
            const executionLog = [];
            
            // Mock class simulating the behavior
            class MockTensCity {
                async _initAceEditor() {
                    executionLog.push('_initAceEditor started');
                    await new Promise(resolve => setTimeout(resolve, 10));
                    executionLog.push('_initAceEditor completed');
                }
                
                async _createEditor() {
                    executionLog.push('_createEditor started');
                    await this._initAceEditor();
                    executionLog.push('_createEditor completed');
                }
                
                async _loadInitialData() {
                    executionLog.push('_loadInitialData started');
                    await new Promise(resolve => setTimeout(resolve, 5));
                    executionLog.push('_loadInitialData completed');
                }
                
                async _showApp() {
                    executionLog.push('_showApp started');
                    await this._createEditor();
                    await this._loadInitialData();
                    executionLog.push('_showApp completed');
                }
            }
            
            const mock = new MockTensCity();
            await mock._showApp();
            
            // Verify execution order
            const expectedOrder = [
                '_showApp started',
                '_createEditor started',
                '_initAceEditor started',
                '_initAceEditor completed',
                '_createEditor completed',
                '_loadInitialData started',
                '_loadInitialData completed',
                '_showApp completed'
            ];
            
            const orderCorrect = JSON.stringify(executionLog) === JSON.stringify(expectedOrder);
            addResult('Execution order is correct', orderCorrect,
                orderCorrect 
                    ? 'All async operations execute in correct order'
                    : `Expected:\n${expectedOrder.join('\n')}\n\nActual:\n${executionLog.join('\n')}`);
            
        } catch (err) {
            addResult('Execution Order Test', false, err.message);
        }

        // Summary
        setTimeout(() => {
            const passedCount = document.querySelectorAll('.pass').length;
            const totalTests = document.querySelectorAll('.status:not(.info)').length;
            const allPassed = passedCount === totalTests;
            const summary = document.createElement('div');
            summary.className = 'status ' + (allPassed ? 'pass' : 'fail');
            summary.innerHTML = `<strong>Summary: ${passedCount}/${totalTests} tests passed</strong>`;
            results.appendChild(summary);
        }, 100);
    </script>
</body>
</html>
