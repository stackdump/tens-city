<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <title>Test: Double-Encoded Permalink Fix - Tens City</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
            background: #f5f5f5;
        }
        .test-info {
            background: white;
            border: 2px solid #0366d6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-info h2 {
            margin: 0 0 16px 0;
            color: #0366d6;
        }
        .test-info h3 {
            margin: 16px 0 8px 0;
            font-size: 16px;
            color: #333;
        }
        .test-info ol, .test-info ul {
            margin: 8px 0;
            padding-left: 20px;
        }
        .test-info li {
            margin: 4px 0;
        }
        .test-info code {
            background: #f6f8fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 13px;
        }
        .test-links {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        .test-links a {
            display: block;
            padding: 10px;
            background: #0366d6;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            text-align: center;
        }
        .test-links a:hover {
            background: #0256c7;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .warning {
            color: #e36209;
            font-weight: bold;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            background: #f6f8fa;
            border: 1px solid #e1e4e8;
        }
    </style>
</head>
<body>
    <div class="test-info">
        <h2>ðŸ”— Double-Encoded Permalink Fix Test</h2>
        
        <h3>Purpose:</h3>
        <p>This test verifies that the permalink feature correctly handles double-encoded URL parameters.</p>
        
        <h3>The Issue:</h3>
        <p>The URL parameter in the issue was double-encoded (encoded twice with <code>encodeURIComponent</code>). The original code only decoded once, leaving the data still URL-encoded and unable to be parsed as JSON.</p>
        
        <h3>The Fix:</h3>
        <p>Modified <code>_loadFromURL()</code> to decode recursively until valid JSON is obtained or no more decoding is possible.</p>
        
        <h3>Test Links:</h3>
        <div class="test-links">
            <a id="single-encoded-link" href="#">1. Test with Single-Encoded URL (backward compatibility)</a>
            <a id="double-encoded-link" href="#">2. Test with Double-Encoded URL (from issue)</a>
            <a id="triple-encoded-link" href="#">3. Test with Triple-Encoded URL (edge case)</a>
        </div>

        <div class="status">
            <h3>Current Page Status:</h3>
            <div id="status-message">Loading...</div>
        </div>

        <h3>Expected Behavior:</h3>
        <ul>
            <li><span class="success">âœ“</span> Single-encoded URLs work (backward compatibility)</li>
            <li><span class="success">âœ“</span> Double-encoded URLs work (fixes the issue)</li>
            <li><span class="success">âœ“</span> Triple-encoded URLs work (robust decoding)</li>
            <li><span class="success">âœ“</span> Invalid URLs show error gracefully</li>
        </ul>
    </div>

    <script type="module">
        // Sample PetriNet data from the issue
        const petriNetData = {
            "@context": "https://pflow.xyz/schema",
            "@id": "ipfs://z2xFpT8KDD7FU8tiWSMcB8n6dxJriy2PtZJrcyCwHkn9fmug732",
            "@type": "PetriNet",
            "@version": "1.1",
            "arcs": [
                {
                    "@type": "Arrow",
                    "inhibitTransition": false,
                    "source": "txn0",
                    "target": "place0",
                    "weight": [1]
                },
                {
                    "@type": "Arrow",
                    "inhibitTransition": false,
                    "source": "place0",
                    "target": "txn1",
                    "weight": [3]
                },
                {
                    "@type": "Arrow",
                    "inhibitTransition": true,
                    "source": "txn2",
                    "target": "place0",
                    "weight": [3]
                },
                {
                    "@type": "Arrow",
                    "inhibitTransition": true,
                    "source": "place0",
                    "target": "txn3",
                    "weight": [1]
                }
            ],
            "places": {
                "place0": {
                    "@type": "Place",
                    "capacity": [3],
                    "initial": [1],
                    "offset": 0,
                    "x": 130,
                    "y": 207
                }
            },
            "token": ["https://pflow.xyz/tokens/black"],
            "transitions": {
                "txn0": {"@type": "Transition", "x": 46, "y": 116},
                "txn1": {"@type": "Transition", "x": 227, "y": 112},
                "txn2": {"@type": "Transition", "x": 43, "y": 307},
                "txn3": {"@type": "Transition", "x": 235, "y": 306}
            }
        };

        const jsonString = JSON.stringify(petriNetData);
        const baseUrl = new URL('index.html', window.location.href).href.split('?')[0];
        
        // Create test URLs with different encoding levels
        const singleEncoded = encodeURIComponent(jsonString);
        const doubleEncoded = encodeURIComponent(singleEncoded);
        const tripleEncoded = encodeURIComponent(doubleEncoded);
        
        document.getElementById('single-encoded-link').href = `${baseUrl}?data=${singleEncoded}`;
        document.getElementById('double-encoded-link').href = `${baseUrl}?data=${doubleEncoded}`;
        document.getElementById('triple-encoded-link').href = `${baseUrl}?data=${tripleEncoded}`;

        // Check if we have a data parameter in current URL
        const urlParams = new URLSearchParams(window.location.search);
        const encodedData = urlParams.get('data');
        const statusDiv = document.getElementById('status-message');
        
        if (encodedData) {
            // Test the decoding logic
            let decodedData = encodedData;
            let decodeCount = 0;
            let lastDecoded = encodedData;
            
            while (true) {
                try {
                    const nextDecoded = decodeURIComponent(decodedData);
                    if (nextDecoded === decodedData) {
                        break;
                    }
                    lastDecoded = decodedData;
                    decodedData = nextDecoded;
                    decodeCount++;
                    
                    try {
                        JSON.parse(decodedData);
                        break;
                    } catch (jsonErr) {
                        if (decodedData === lastDecoded) {
                            break;
                        }
                    }
                } catch (e) {
                    break;
                }
            }
            
            try {
                const parsed = JSON.parse(decodedData);
                statusDiv.innerHTML = `
                    <strong style="color: #28a745;">âœ“ SUCCESS</strong><br>
                    <strong>Decoding iterations:</strong> ${decodeCount}<br>
                    <strong>Data type:</strong> ${parsed['@type']}<br>
                    <strong>Context:</strong> ${parsed['@context']}<br>
                    <strong>Data loaded successfully!</strong>
                `;
            } catch (err) {
                statusDiv.innerHTML = `
                    <strong style="color: #d73a49;">âœ— FAILED</strong><br>
                    <strong>Error:</strong> ${err.message}<br>
                    <strong>Decoding iterations:</strong> ${decodeCount}<br>
                    <strong>Partial decode:</strong> ${decodedData.substring(0, 50)}...
                `;
            }
        } else {
            statusDiv.innerHTML = `
                <strong>No data parameter in URL.</strong><br>
                Click one of the test links above to test the fix.
            `;
        }
    </script>
</body>
</html>
